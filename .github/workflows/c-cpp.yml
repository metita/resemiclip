name: C/C++ CI

on:
  push:
    branches: [master]
    paths-ignore:
      - '**.md'
      - '.github/**'

  pull_request:
    types: [opened, reopened, synchronize]

  release:
    types: [published]

  workflow_dispatch:

jobs:

  windows:
    name: Windows
    runs-on: windows-2025

    env:
      solution: 'msvc/resemiclip.sln'
      buildPlatform: 'Win32'
      buildRelease: 'Release'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Select PlatformToolset
        id: select_toolset
        shell: pwsh
        run: |
          $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          $vs2019 = & $vswhere -products * -version "[16.0,17.0)" -property installationPath -latest
          $vs2022 = & $vswhere -products * -version "[17.0,)" -property installationPath -latest
          
          if ($vs2019) {
            "toolset=v140_xp" >> $env:GITHUB_OUTPUT
          } elseif ($vs2022) {
            "toolset=v143" >> $env:GITHUB_OUTPUT
          } else {
            Write-Error "No suitable Visual Studio installation found"
            exit 1
          }

      - name: Build
        shell: pwsh
        run: |
          $toolset = '${{ steps.select_toolset.outputs.toolset }}'
          msbuild ${{ env.solution }} -p:Configuration="${{ env.buildRelease }}" /t:Clean,Build /p:Platform=${{ env.buildPlatform }} /p:PlatformToolset=$toolset /p:XPDeprecationWarning=false

      - name: Copy Binary files
        shell: pwsh
        run: |
          mkdir publish\addons\resemiclip
          move msvc\${{ env.buildRelease }}\resemiclip_mm.dll publish\addons\resemiclip\resemiclip_mm.dll

      - name: Get app version
        id: get_version
        shell: pwsh
        run: |
          $versionFile = "version/appversion.h"
          $content = Get-Content $versionFile
          foreach ($line in $content) {
            if ($line -match '^\s*#define\s+APP_VERSION\s+"([^"]+)"') {
              $version = $matches[1]
              "version=$version" >> $env:GITHUB_OUTPUT
              exit 0
            }
          }
          Write-Error "APP_VERSION not found"
          exit 1

      - name: Install rcedit
        shell: pwsh
        run: choco install rcedit -y

      - name: Edit resources
        shell: pwsh
        run: |
          rcedit publish\addons\resemiclip\resemiclip_mm.dll `
            --set-version-string ProductName "ReSemiclip - resemiclip_mm.dll" `
            --set-file-version "${{ steps.get_version.outputs.version }}" `
            --set-product-version "${{ steps.get_version.outputs.version }}" `
            --set-version-string FileDescription "ReSemiclip - Commit: $env:GITHUB_SHA" `
            --set-version-string Comments "Commit: $env:GITHUB_SHA" `
            --set-version-string CompanyName "ReHLDS Dev Team" `
            --set-version-string LegalCopyright "Copyright 2025 Valve, ReHLDS DevTeam" `
            --set-icon msvc/icon.ico

      - name: Sign DLL
        if: github.event_name == 'release'
        shell: pwsh
        env:
          KEY_PFX_PASS: ${{ secrets.KEY_PFX_PASS }}
        run: |
          [IO.File]::WriteAllBytes("signing-cert.pfx", [Convert]::FromBase64String("${{ secrets.KEY_PFX_B64 }}"))
          certutil -f -p "${{ secrets.KEY_PFX_PASS }}" -importPFX signing-cert.pfx
          & 'C:\Program Files (x86)\Windows Kits\10\bin\10.0.26100.0\x86\signtool.exe' sign /a /f signing-cert.pfx /p $env:KEY_PFX_PASS /fd sha256 /tr http://timestamp.digicert.com /td sha256 publish\addons\resemiclip\resemiclip_mm.dll
          Remove-Item signing-cert.pfx

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: win32
          path: publish/*

  linux:
    name: Linux
    runs-on: ubuntu-24.04
    container: debian:11-slim

    outputs:
      app-version: ${{ steps.app-version.outputs.version }}

    steps:
      - name: Install dependencies
        run: |
          dpkg --add-architecture i386
          apt-get update
          apt-get install -y \
            gcc-multilib g++-multilib \
            build-essential libc6-dev libc6-dev-i386 \
            git cmake rsync p7zip-full gnupg

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build
        run: |
          rm -rf build
          CC=gcc CXX=g++ cmake -B build
          cmake --build build -j8

      - name: Read version
        id: app-version
        shell: bash
        run: |
          APP_VERSION=$(grep -wi 'APP_VERSION_STRD' version/appversion.h | sed -E 's/.*"(.*)".*/\1/')
          echo "version=$APP_VERSION" >> $GITHUB_OUTPUT

      - name: Prepare files
        run: |
          mkdir -p publish/addons/resemiclip
          rsync -a dist/ publish/addons/resemiclip/
          mv build/resemiclip_mm_i386.so publish/addons/resemiclip/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux32
          path: publish/*

  publish:
    name: Publish
    runs-on: ubuntu-latest
    needs: [windows, linux]

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: linux32

      - uses: actions/download-artifact@v4
        with:
          name: win32

      - name: Package & Sign
        if: github.event_name == 'release'
        shell: bash
        run: |

          if [ -z "${{ secrets.PUB_ASC }}" ] || [ -z "${{ secrets.KEY_ASC }}" ]; then
            echo "Missing GPG secrets"
            exit 1
          fi

          echo "${{ secrets.PUB_ASC }}" > pubkey.asc
          echo "${{ secrets.KEY_ASC }}" > privatekey.asc

          gpg --batch --yes --import pubkey.asc
          gpg --batch --yes --import privatekey.asc

          FPR=$(gpg --list-keys --with-colons | grep '^fpr' | head -n1 | cut -d: -f10)
          echo "$FPR:6:" | gpg --batch --import-ownertrust

          VERSION="${{ needs.linux.outputs.app-version }}"

          7z a -tzip resemiclip-${VERSION}.zip addons/

          gpg --batch --yes --detach-sign --armor -u "$FPR" resemiclip-${VERSION}.zip

      - name: Publish Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            *.zip
            *.asc
        env:
          GITHUB_TOKEN: ${{ secrets.API_TOKEN }}
